x-app: &app
  build:
    context: ../backend/
    dockerfile: Dockerfile
  depends_on:
    db:
      condition: service_healthy
  environment:
    # FastAPI Core
    - SECRET_KEY=${SECRET_KEY:-change-me}
    - ALGORITHM=${ALGORITHM:-HS256}
    - ACCESS_TOKEN_LIFETIME_MINUTES=${ACCESS_TOKEN_LIFETIME_MINUTES:-5}
    - REFRESH_TOKEN_LIFETIME_DAYS=${REFRESH_TOKEN_LIFETIME_DAYS:-30}
    - AUTO_CREATE_TABLES=${AUTO_CREATE_TABLES:-False}
    - APP_NAME=${APP_NAME:-Spraply API}
    - APP_DESCRIPTION=${APP_DESCRIPTION:-FastAPI backend for Spraply}
    - APP_VERSION=${APP_VERSION:-1.0.0}
    
    # Database
    - DATABASE_URL=postgresql+psycopg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@${POSTGRES_HOST:-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}
    
    # MinIO
    - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
    - MINIO_EXTERNAL_ENDPOINT=${MINIO_EXTERNAL_ENDPOINT:-minio:9000}
    - MINIO_REGION=${MINIO_REGION:-}
    - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minio}
    - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minio123}
    - MINIO_USE_HTTPS=${MINIO_USE_HTTPS:-False}
    - MINIO_EXTERNAL_ENDPOINT_USE_HTTPS=${MINIO_EXTERNAL_ENDPOINT_USE_HTTPS:-False}
    - MINIO_URL_EXPIRY_HOURS=${MINIO_URL_EXPIRY_HOURS:-7}
    - MINIO_CONSISTENCY_CHECK_ON_START=${MINIO_CONSISTENCY_CHECK_ON_START:-False}
    - MINIO_PRIVATE_BUCKET=${MINIO_PRIVATE_BUCKET:-private}
    - MINIO_PUBLIC_BUCKET=${MINIO_PUBLIC_BUCKET:-public}
    - MINIO_BUCKET_CHECK_ON_SAVE=${MINIO_BUCKET_CHECK_ON_SAVE:-False}
    
    # CORS
    - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-}
    - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
    - CORS_ALLOWED_ORIGIN_REGEXES=${CORS_ALLOWED_ORIGIN_REGEXES:-}
    - CORS_ALLOW_ALL_ORIGINS=${CORS_ALLOW_ALL_ORIGINS:-False}
    
    # Authentication
    - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
    - IS_LOGIN_ACTIVE=${IS_LOGIN_ACTIVE:-True}
    - IS_SIGNUP_ACTIVE=${IS_SIGNUP_ACTIVE:-True}
    - IS_GITHUB_LOGIN_ACTIVE=${IS_GITHUB_LOGIN_ACTIVE:-True}
    - IS_GOOGLE_LOGIN_ACTIVE=${IS_GOOGLE_LOGIN_ACTIVE:-True}
    - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
    - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
    - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
    - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
    - ACCESS_TOKEN_LIFETIME_MINUTES=${ACCESS_TOKEN_LIFETIME_MINUTES:-5}
    - REFRESH_TOKEN_LIFETIME_DAYS=${REFRESH_TOKEN_LIFETIME_DAYS:-30}
    
    # Email
    - EMAIL_BACKEND=${EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
    - EMAIL_HOST=${EMAIL_HOST:-}
    - EMAIL_PORT=${EMAIL_PORT:-587}
    - EMAIL_USE_TLS=${EMAIL_USE_TLS:-True}
    - EMAIL_HOST_USER=${EMAIL_HOST_USER:-}
    - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD:-}
    - DEFAULT_FROM_EMAIL=${DEFAULT_FROM_EMAIL:-}
    
    # FastAPI settings parity
    - MAX_CRAWL_CONCURRENCY=${MAX_CRAWL_CONCURRENCY:-16}
    - API_VERSION=${API_VERSION:-1.0.0}
    - POLICY_URL=${POLICY_URL:-}
    - TERMS_URL=${TERMS_URL:-}

    # Playwright
    - PLAYWRIGHT_SERVER=${PLAYWRIGHT_SERVER:-http://playwright:8000}
    - PLAYWRIGHT_API_KEY=${PLAYWRIGHT_API_KEY:-your-secret-api-key}
    
    # Integrations
    - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
    - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
    - GOOGLE_ANALYTICS_ID=${GOOGLE_ANALYTICS_ID:-}
    
    # Feature flags
    - IS_ENTERPRISE_MODE_ACTIVE=${IS_ENTERPRISE_MODE_ACTIVE:-False}
    - MAX_CRAWL_DEPTH=${MAX_CRAWL_DEPTH:--1}
    - CAPTURE_USAGE_HISTORY=${CAPTURE_USAGE_HISTORY:-True}

    # MCP
    - MCP_SERVER=${MCP_SERVER:-http://localhost/sse}

    # Sentry Settings
    # ---------------
    - SENTRY_DSN=${SENTRY_DSN:-}
    - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-1.0}
    - SENTRY_SEND_DEFAULT_PII=${SENTRY_SEND_DEFAULT_PII:-False}
    - SENTRY_ENABLE_LOGS=${SENTRY_ENABLE_LOGS:-True}
    - SENTRY_HTTP_PROXY=${SENTRY_HTTP_PROXY:-}
    - SENTRY_HTTPS_PROXY=${SENTRY_HTTPS_PROXY:-}
    - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
    - SENTRY_DEBUG=${SENTRY_DEBUG:-False}

x-frontend: &frontend
  image: spraply-frontend:${VERSION:-dev}
  build:
    context: ../frontend/
    dockerfile: Dockerfile
    args:
      VITE_APP_VERSION: ${VERSION:-dev}
  environment:
    - VITE_API_BASE_URL=${API_BASE_URL:-}
    - VITE_SENTRY_DSN=${SENTRY_FRONTEND_DSN:-}
    - VITE_SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
    - VITE_SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-1.0}
    - VITE_SENTRY_REPLAYS_SESSION_SAMPLE_RATE=${SENTRY_REPLAYS_SESSION_SAMPLE_RATE:-1.0}
    - VITE_SENTRY_REPLAYS_ON_ERROR_SAMPLE_RATE=${SENTRY_REPLAYS_ON_ERROR_SAMPLE_RATE:-1.0}
    - VITE_SENTRY_SEND_DEFAULT_PII=${SENTRY_SEND_DEFAULT_PII:-False}
    - VITE_SENTRY_ENABLE_LOGS=${SENTRY_ENABLE_LOGS:-True}
  depends_on:
    - app

services:
  nginx:
    image: nginx:alpine
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/templates/default.conf.template
    environment:
      - MINIO_PRIVATE_BUCKET=${MINIO_PRIVATE_BUCKET:-private}
      - MINIO_PUBLIC_BUCKET=${MINIO_PUBLIC_BUCKET:-public}
    depends_on:
      - app
      - frontend
      - minio
    restart: always

  app:
    <<: *app
    command: [ "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "9000", "--workers", "2" ]

  frontend:
    <<: *frontend
    # Uses the nginx-based image built by ../frontend/Dockerfile.

  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    restart: always
    volumes:
      - ./volumes/minio-data:/data
    command: server /data --console-address ":9001"
    environment:
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL:-http://localhost/minio-console/}
      - MINIO_SERVER_URL=${MINIO_SERVER_URL:-http://localhost/}
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minio}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minio123}

  playwright:
    profiles: ["extras"]
    image: Spraply/playwright:1.1
    restart: always
    user: root
    environment:
      - AUTH_API_KEY=${PLAYWRIGHT_API_KEY:-your-secret-api-key}
      - PORT=${PLAYWRIGHT_PORT:-8000}
      - HOST=${PLAYWRIGHT_HOST:-0.0.0.0}

  db:
    image: postgres:17.2-alpine3.21
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
    volumes:
      - ./volumes/postgres-db:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mcp:
    profiles: ["extras"]
    image: Spraply/mcp:v1.2.0
    restart: always
    command: [ "sse", "--base-url", "http://app:9000", '--port', '3000', '--endpoint', '/sse' ]

  redis:
    image: redis:latest
    restart: always
